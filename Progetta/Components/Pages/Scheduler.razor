@page "/scheduler"
@using System.Globalization
@rendermode InteractiveServer
@inject TaskService TaskService
@inject UserService UserService

<DxScheduler @rendermode="InteractiveAuto"
             @bind-StartDate="@StartDate"
             DataStorage="@_dataStorage"
             ValidateEditForm="true"
             @bind-ActiveViewType="@ActiveViewType"
             @bind-AppointmentFormMode="@AppointmentFormMode"
             AppointmentUpdated="OnAppointmentUpdate"
             AppointmentFormShowing="OnAppointmentFormShowing"
             CssClass="demo-sc-size">
    <Views>
        <DxSchedulerDayView VisibleTime="@VisibleTime"></DxSchedulerDayView>
         <DxSchedulerWorkWeekView VisibleTime="@VisibleTime"></DxSchedulerWorkWeekView>
        <DxSchedulerWeekView VisibleTime="@VisibleTime"></DxSchedulerWeekView>
        <DxSchedulerMonthView CellMinWidth="120"></DxSchedulerMonthView>
        <DxSchedulerTimelineView Duration="@(TimeSpan.FromDays(7))" CellMinWidth="100">
            <Scales>
                <DxSchedulerTimeScale Unit="@SchedulerTimeScaleUnit.Week"></DxSchedulerTimeScale>
                <DxSchedulerTimeScale Unit="@SchedulerTimeScaleUnit.Day"></DxSchedulerTimeScale>
            </Scales>
        </DxSchedulerTimelineView> 
    </Views>
    <AppointmentFormHeaderTemplate>
        <div class="popup-text-header">@context.Subject</div>
        <DxSchedulerSaveAppointmentChangesButton></DxSchedulerSaveAppointmentChangesButton>
        <DxSchedulerDeleteAppointmentButton Text="@null"></DxSchedulerDeleteAppointmentButton>
        <DxSchedulerDiscardAppointmentChangesButton></DxSchedulerDiscardAppointmentChangesButton>
        @if (AppointmentFormMode == SchedulerAppointmentFormMode.Both)
        {
            <DxButton Click="@(() => {})"
                      IconCssClass="btn-icon-back"
                      RenderStyle="ButtonRenderStyle.None"
                      CssClass="dxbl-btn-tool">
            </DxButton>
        }
    </AppointmentFormHeaderTemplate>
    <AppointmentFormLayout Context="formInfo">
        <DxSchedulerSubjectFormLayoutItem></DxSchedulerSubjectFormLayoutItem>
        <DxSchedulerAllDayFormLayoutItem></DxSchedulerAllDayFormLayoutItem>
        <DxSchedulerStartDateFormLayoutItem></DxSchedulerStartDateFormLayoutItem>
        <DxSchedulerStartTimeFormLayoutItem></DxSchedulerStartTimeFormLayoutItem>
        <DxSchedulerEndDateFormLayoutItem></DxSchedulerEndDateFormLayoutItem>
        <DxSchedulerEndTimeFormLayoutItem></DxSchedulerEndTimeFormLayoutItem>
        <DxSchedulerLabelFormLayoutItem></DxSchedulerLabelFormLayoutItem>
        <DxSchedulerDescriptionFormLayoutItem></DxSchedulerDescriptionFormLayoutItem>
        <DxSchedulerCustomFormLayoutItem ColSpanMd="12">
            <Template>
                <ValidationSummary />
            </Template>
        </DxSchedulerCustomFormLayoutItem>
    </AppointmentFormLayout>
    <AppointmentCompactFormHeaderTemplate>
        <div class="popup-text-header">@context.Subject</div>
        <DxSchedulerSaveAppointmentChangesButton></DxSchedulerSaveAppointmentChangesButton>
        <DxSchedulerDeleteAppointmentButton Text="@null"></DxSchedulerDeleteAppointmentButton>
        <DxSchedulerDiscardAppointmentChangesButton></DxSchedulerDiscardAppointmentChangesButton>
        @if (AppointmentFormMode == SchedulerAppointmentFormMode.Both)
        {
            <DxSchedulerShowAppointmentEditFormButton></DxSchedulerShowAppointmentEditFormButton>
        }
    </AppointmentCompactFormHeaderTemplate>
    <AppointmentCompactFormLayout Context="formInfo">
        <DxSchedulerSubjectFormLayoutItem></DxSchedulerSubjectFormLayoutItem>
        <DxSchedulerAllDayFormLayoutItem></DxSchedulerAllDayFormLayoutItem>
        <DxSchedulerStartDateFormLayoutItem></DxSchedulerStartDateFormLayoutItem>
        <DxSchedulerStartTimeFormLayoutItem></DxSchedulerStartTimeFormLayoutItem>
        <DxSchedulerEndDateFormLayoutItem></DxSchedulerEndDateFormLayoutItem>
        <DxSchedulerEndTimeFormLayoutItem></DxSchedulerEndTimeFormLayoutItem>
        <DxSchedulerCustomFormLayoutItem ColSpanMd="12">
            <Template>
                <DxComboBox Data="AllUsers"
                            @bind-Value="@(((CustomAppointmentFormInfo)formInfo).AssignedTo)">
            </DxComboBox>
            </Template>
        </DxSchedulerCustomFormLayoutItem>
        <DxSchedulerDescriptionFormLayoutItem></DxSchedulerDescriptionFormLayoutItem>
        <DxSchedulerCustomFormLayoutItem ColSpanMd="12">
            <Template>
                <ValidationSummary />
            </Template>
        </DxSchedulerCustomFormLayoutItem>
    </AppointmentCompactFormLayout>
</DxScheduler>

@code {
    List<User> AllUsers = new List<User>();

    public DxScheduler SchedulerItem { get; set; }
    DateTime StartDate { get; set; } = DateTime.Today;
    SchedulerAppointmentFormMode AppointmentFormMode { get; set; } = SchedulerAppointmentFormMode.Both;
    SchedulerViewType ActiveViewType { get; set; } = SchedulerViewType.Day;
    DxSchedulerTimeSpanRange VisibleTime = new DxSchedulerTimeSpanRange(TimeSpan.FromHours(8), TimeSpan.FromHours(19));
    private DxSchedulerDataStorage _dataStorage;


    public async Task OnAppointmentUpdate(DxSchedulerAppointmentItem item)
    {
        if (item.Id is int id)
        {
            TaskToDo taskToDo = await TaskService.GetTaskToDoByIdAsync(id);

            taskToDo.Name = item.Subject;
            taskToDo.Description = item.Description;
            taskToDo.StartAt = item.Start;
            taskToDo.DueDate = item.End;
            taskToDo.Priority = (TaskPriority)(int)item.LabelId;

            var assignedTo = item.CustomFields["AssignedTo"];

            await TaskService.UpdateTaskToDoAsync(taskToDo);
        }
    }


    protected override async Task OnInitializedAsync()
    {
        AllUsers = await UserService.GetUsersAsync();

        var tasksToDo = await TaskService.GetAllTasksToDoAsync();

        List<Appointment> appointments = new List<Appointment>();
        foreach (TaskToDo taskToDo in tasksToDo)
        {
            DateTime startAt = taskToDo.StartAt ?? DateTime.Now;
            DateTime endDate = taskToDo.DueDate ?? DateTime.Now;

            Appointment appointment = new Appointment
            {
                Id = taskToDo.Id,
                AppointmentType = 0,
                Caption = $"{taskToDo.Name}\n\r{(taskToDo.AssignedTo?.FullName ?? string.Empty)}",
                Label = (int)taskToDo.AssignedTo.LabelId,
                StartDate = startAt,
                EndDate = endDate,
                Description = taskToDo.Description,
                ResourceId = 0,
                AssignedTo = taskToDo.AssignedTo
            };
            
            appointments.Add(appointment);
        }

        _dataStorage = new DxSchedulerDataStorage()
            {
                AppointmentsSource = appointments,
                AppointmentMappings = new DxSchedulerAppointmentMappings()
                {
                    Id = "Id",
                    Type = "AppointmentType",
                    Start = "StartDate",
                    End = "EndDate",
                    Subject = "Caption",
                    AllDay = "AllDay",
                    Description = "Description",
                    LabelId = "Label",
                    StatusId = "Status",
                    CustomFieldMappings = [
                        new DxSchedulerCustomFieldMapping { Name = "AssignedTo", Mapping = "AssignedTo" }
                    ]

                }
            };
    }

    private static string ToString(DateTime dateTime)
    {
        return dateTime.ToString(CultureInfo.InvariantCulture);
    }

    void OnAppointmentFormShowing(SchedulerAppointmentFormEventArgs args)
    {
        args.FormInfo = new CustomAppointmentFormInfo(args.Appointment, DataStorage, SchedulerItem);
    }

    public class CustomAppointmentFormInfo : SchedulerAppointmentFormInfo
    {
        public CustomAppointmentFormInfo(DxSchedulerAppointmentItem AppointmentItem, DxSchedulerDataStorage DataStorage, DxScheduler scheduler)
            : base(AppointmentItem, DataStorage, scheduler) {}


        public override string Subject
        {
            get { return base.Subject; }
            set { base.Subject = value; }
        }

        public User AssignedTo
        {
            get { return (User)CustomFields["AssignedTo"]; }
            set { CustomFields["AssignedTo"] = value; }
        }
    }

    public class Appointment
    {
        public Appointment() { }
        public int Id { get; set; }
        public int AppointmentType { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string Caption { get; set; }
        public string Description { get; set; }
        public int? Label { get; set; }
        public int Status { get; set; }
        public bool AllDay { get; set; }
        public string Recurrence { get; set; }
        public int? ResourceId { get; set; }
        public string Resources { get; set; }
        public bool Accepted { get; set; }
        public User AssignedTo { get; set; }
    }

    public DxSchedulerDataStorage DataStorage => _dataStorage;
}


